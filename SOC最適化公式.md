# SOC最適化公式とスケジュール

## 📊 分析結果サマリー

### データ分析（9月25日、26日）

分析した結果、SOC変化率と基準値（需要計画kW）の間に非常に強い線形関係が見つかりました。

#### 観測データ

**9月25日:**
- 06:00-09:00: 基準値 1998kW → SOC 5% → 76% (変化率: +23.80%/時間)
- 09:00-12:00: 基準値 0kW → SOC 76% → 67% (変化率: -3.02%/時間)
- 12:00-15:00: 基準値 532kW → SOC 67% → 82% (変化率: +5.03%/時間)

**9月26日:**
- 06:00-09:00: 基準値 1998kW → SOC 11% → 81% (変化率: +23.46%/時間)
- 09:00-12:00: 基準値 0kW → SOC 81% → 69% (変化率: -4.02%/時間)
- 12:00-15:00: 基準値 532kW → SOC 69% → 83% (変化率: +4.69%/時間)

---

## 🔬 導出された公式

### 線形回帰結果

```
SOC変化率 (%/時間) = 0.012804 × 基準値(kW) - 1.9515

相関係数 (R²) = 0.9997 ← 非常に高い相関！
P値 = 0.0002 ← 統計的に有意
```

### 最適基準値の計算式

SOC ≤ 90%の制約下で基準値の合計を最大化する場合:

```
最適基準値(kW) = (利用可能SOC / 3時間 + 1.9515) / 0.012804

ここで:
  利用可能SOC = 90% - 現在のSOC(%)
  3時間 = 1ブロックの時間
```

---

## 📋 現在SOC別の最適基準値表

| 現在SOC | 利用可能SOC | 最適基準値 (kW) | 3時間後のSOC | SOC増加 |
|---------|-------------|-----------------|--------------|---------|
| 5%      | 85%         | 2,365           | 90%          | +85%    |
| 10%     | 80%         | 2,235           | 90%          | +80%    |
| 20%     | 70%         | 1,975           | 90%          | +70%    |
| 30%     | 60%         | 1,714           | 90%          | +60%    |
| 40%     | 50%         | 1,454           | 90%          | +50%    |
| 50%     | 40%         | 1,194           | 90%          | +40%    |
| 60%     | 30%         | 933             | 90%          | +30%    |
| 70%     | 20%         | 673             | 90%          | +20%    |
| 80%     | 10%         | 413             | 90%          | +10%    |

---

## 💡 実用例

### シナリオ1: 初期SOC 5%（最大基準値）

| Block | 時間帯 | 開始SOC | 最適基準値 | 予想SOC | SOC増加 |
|-------|--------|---------|------------|---------|---------|
| 1     | 06:00-09:00 | 5.0%    | 2,365 kW   | 90.0%   | +85.0%  |
| 2     | 09:00-12:00 | 90.0%   | 152 kW     | 90.0%   | +0.0%   |
| 3     | 12:00-15:00 | 90.0%   | 152 kW     | 90.0%   | +0.0%   |

**合計基準値: 2,669 kW**

### シナリオ2: 初期SOC 20%

| Block | 時間帯 | 開始SOC | 最適基準値 | 予想SOC | SOC増加 |
|-------|--------|---------|------------|---------|---------|
| 1     | 06:00-09:00 | 20.0%   | 1,975 kW   | 90.0%   | +70.0%  |
| 2     | 09:00-12:00 | 90.0%   | 152 kW     | 90.0%   | +0.0%   |
| 3     | 12:00-15:00 | 90.0%   | 152 kW     | 90.0%   | +0.0%   |

**合計基準値: 2,279 kW**

### シナリオ3: 初期SOC 50%

| Block | 時間帯 | 開始SOC | 最適基準値 | 予想SOC | SOC増加 |
|-------|--------|---------|------------|---------|---------|
| 1     | 06:00-09:00 | 50.0%   | 1,194 kW   | 90.0%   | +40.0%  |
| 2     | 09:00-12:00 | 90.0%   | 152 kW     | 90.0%   | +0.0%   |
| 3     | 12:00-15:00 | 90.0%   | 152 kW     | 90.0%   | +0.0%   |

**合計基準値: 1,498 kW**

---

## 🎯 最適化戦略

### 基本原則

1. **SOC < 90%の維持**: 制約条件として必須
2. **基準値の最大化**: 各3時間ブロックで可能な限り高い基準値を設定
3. **動的調整**: 現在のSOCに応じて基準値を調整

### 推奨手順

1. 各3時間ブロックの開始時にSOCを確認
2. 上記の公式または表を使用して最適基準値を計算
3. 基準値を設定
4. 3時間後に再評価

### 注意点

- **SOCが90%に達した場合**: 基準値を152kW（最小値）に設定してSOCを維持
- **SOCが90%を超える場合**: 基準値を0kWまたは負の値に設定して放電
- **実際の実績値kWも考慮**: 実績値が基準値と大きく異なる場合は調整が必要

---

## 📈 実測値との比較

### 9月25日の実測値

| 時間帯 | 実測基準値 | 実測SOC変化 | 最適基準値 | 予想SOC変化 | 差異 |
|--------|------------|-------------|------------|-------------|------|
| 06:00-09:00 | 1998 kW | 5% → 76% (+71%) | 2365 kW | 5% → 90% (+85%) | -367 kW |
| 09:00-12:00 | 0 kW | 76% → 67% (-9%) | - | - | - |
| 12:00-15:00 | 532 kW | 67% → 82% (+15%) | 673 kW | 67% → 87% (+20%) | -141 kW |

**結論**: 実測値は最適値よりも低めに設定されていた。最適値を使用すれば、より効率的にSOCを90%まで上げ、基準値の合計を最大化できる。

---

## 🛠️ 使用ツール

### Python計算ツール

`optimal_baseline_calculator.py`を使用して、任意の初期SOCから最適スケジュールを生成できます:

```python
from optimal_baseline_calculator import calculate_optimal_baseline

# 現在SOC 30%の場合の最適基準値を計算
optimal_kw, predicted_soc = calculate_optimal_baseline(
    current_soc=30,
    target_soc_max=90,
    block_hours=3
)

print(f"最適基準値: {optimal_kw:.0f} kW")
print(f"予想SOC: {predicted_soc:.1f} %")
```

### 出力ファイル

- `soc_optimization_analysis.html`: 分析グラフ
- `optimal_baseline_schedule.csv`: 最適スケジュールCSV

---

## 📝 まとめ

1. **発見した関係式**: SOC変化率 = 0.012804 × 基準値 - 1.9515 (R² = 0.9997)
2. **最適化公式**: 最適基準値 = (90 - 現在SOC) / 3 / 0.012804 + 1.9515 / 0.012804
3. **実用的な結論**: 
   - 低SOC (5-20%)の場合: 2000-2400 kWの高い基準値を設定可能
   - 中SOC (30-60%)の場合: 1200-1700 kWの中程度の基準値
   - 高SOC (70-80%)の場合: 400-700 kWの低めの基準値
4. **合計基準値の最大化**: 初期SOCが低いほど、1日の合計基準値を高くできる

この公式を使用することで、SOCを90%以下に保ちながら、3時間ブロックごとの基準値（需要計画kW）の合計を最大化できます。
