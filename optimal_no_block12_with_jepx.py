"""
ブロック1,2不参加 + JEPX参加の最適基準値
"""

print("="*80)
print("ブロック1,2不参加 + JEPX参加の最適基準値")
print("="*80)

# 係数
coef = 0.040635
intercept = 8.4591

print("\n【1. 問題設定】")
print("-"*80)
print("参加ブロック: 3, 4, 5, 6, 7 (5ブロック)")
print("JEPX: 参加 (ブロック8, ΔSOC = +85%)")
print("目的: 総容量 Σbᵢ を最大化")

print("\n【2. 制約条件】")
print("-"*80)
print("サイクル制約:")
print("  Σ(ΔSOC_baseline) + ΔSOC_JEPX = 0")
print("  5 × (0.040635 × b - 8.4591) + 85 = 0")
print("")
print("基準値制約:")
print("  0 ≤ bᵢ ≤ 2,000 kW")
print("")
print("SOC制約:")
print("  5% ≤ SOC ≤ 90%")

print("\n【3. 最適化問題】")
print("-"*80)
print("目的関数:")
print("  max Σbᵢ = b₃ + b₄ + b₅ + b₆ + b₇")
print("")
print("制約条件:")
print("  Σ(0.040635 × bᵢ - 8.4591) = -85")
print("  0.040635 × Σbᵢ - 5 × 8.4591 = -85")
print("  0.040635 × Σbᵢ = -85 + 42.2955")
print("  0.040635 × Σbᵢ = -42.7045")
print("  Σbᵢ = -42.7045 / 0.040635")
print("  Σbᵢ = -1,051.07 kW  ❌ (負の値!)")

print("\n【4. 正しい計算】")
print("-"*80)
print("サイクル制約を再確認:")
print("  Σ(ΔSOC_baseline) + ΔSOC_JEPX = 0")
print("  Σ(ΔSOC_baseline) = -ΔSOC_JEPX")
print("  Σ(ΔSOC_baseline) = -85")
print("")
print("5ブロックの場合:")
print("  5 × (0.040635 × b - 8.4591) = -85")
print("  0.203175 × b - 42.2955 = -85")
print("  0.203175 × b = -85 + 42.2955")
print("  0.203175 × b = -42.7045")
print("  b = -42.7045 / 0.203175")
print("  b = -210.17 kW  ❌ (負の値!)")

print("\n【5. サイクル制約の正しい理解】")
print("-"*80)
print("24時間でSOCが元に戻る条件:")
print("  初期SOC = 最終SOC")
print("  5% + Σ(ΔSOC) = 5%")
print("  Σ(ΔSOC) = 0")
print("")
print("つまり:")
print("  Σ(ΔSOC_baseline) + ΔSOC_JEPX = 0")
print("  Σ(ΔSOC_baseline) = -ΔSOC_JEPX")
print("")
print("JEPXで充電(+85%)するなら:")
print("  baselineで放電(-85%)する必要がある")
print("  Σ(ΔSOC_baseline) = -85%")

print("\n【6. 均等分布を仮定した場合】")
print("-"*80)
print("各ブロックが同じ基準値 b を使う:")
print("  5 × (0.040635 × b - 8.4591) = -85")
print("  0.040635 × b - 8.4591 = -17")
print("  0.040635 × b = -17 + 8.4591")
print("  0.040635 × b = -8.5409")
print("  b = -8.5409 / 0.040635")
print("  b = -210.17 kW  ❌")

print("\n【7. 問題の分析】")
print("-"*80)
print("なぜ負の値になるのか？")
print("")
print("1ブロックのΔSOC式:")
print("  ΔSOC = 0.040635 × b - 8.4591")
print("")
print("ΔSOC = -17% にするには:")
print("  0.040635 × b - 8.4591 = -17")
print("  0.040635 × b = -8.5409")
print("  b = -210 kW  ❌ (負の基準値は不可)")
print("")
print("つまり、b ≥ 0 の制約下では ΔSOC = -17% を実現できない!")

print("\n【8. 実現可能な解】")
print("-"*80)
print("基準値 b ≥ 0 の範囲で最小のΔSOCは？")
print("  b = 0 のとき:")
print("  ΔSOC = 0.040635 × 0 - 8.4591 = -8.4591%")
print("")
print("これは -17% より大きい (絶対値は小さい)")
print("")
print("結論: 5ブロックのみでは JEPX +85% を相殺できない!")

print("\n【9. 一般式による検証】")
print("-"*80)
print("n ブロックで JEPX +85% を相殺するには:")
print("  n × (0.040635 × b - 8.4591) = -85")
print("  0.040635 × b - 8.4591 = -85/n")
print("  0.040635 × b = 8.4591 - 85/n")
print("  b = (8.4591 - 85/n) / 0.040635")
print("")
print("b ≥ 0 となる条件:")
print("  8.4591 - 85/n ≥ 0")
print("  8.4591 ≥ 85/n")
print("  n ≥ 85/8.4591")
print("  n ≥ 10.05")
print("")
print("つまり、最低でも 11ブロック必要!")

print("\n【10. n = 5 の場合の正しい解】")
print("-"*80)
print("実際のデータから逆算:")
print("  通常ケース(7ブロック): 各507 kW")
print("  5ブロックの場合も各507 kWと仮定")
print("")
print("検証:")
delta_b = coef * 507 - intercept
print(f"  1ブロックのΔSOC = 0.040635 × 507 - 8.4591 = {delta_b:.4f}%")
print(f"  5ブロックの合計 = 5 × {delta_b:.4f} = {5*delta_b:.4f}%")
print(f"  JEPX = +85%")
print(f"  合計 = {5*delta_b:.4f} + 85 = {5*delta_b + 85:.4f}%")
print("")
print("これは 0% ではない!")
print("つまり、SOCが元に戻らない")

soc = 5.0
print(f"\nSOC推移:")
print(f"  初期: {soc:.2f}%")
soc += 5 * delta_b
print(f"  ブロック3-7後: {soc:.2f}%")
soc += 85
print(f"  JEPX後: {soc:.2f}%")
print(f"  差: {soc - 5:.2f}% ≠ 0")

print("\n【11. 結論】")
print("="*80)
print("ブロック1,2不参加 + JEPX参加の場合:")
print("")
print("1. 理論的には:")
print("   5ブロックだけではJEPX +85%を相殺できない")
print("   最低11ブロック必要 (85/8.4591 = 10.05)")
print("")
print("2. 実際のシステムでは:")
print("   各ブロック 507 kW を使用")
print("   総容量 = 5 × 507 = 2,535 kW")
print("   ただし、SOCが完全に元に戻らない可能性")
print("")
print("3. 推奨:")
print("   - SOC制約 (5%-90%) を明示的に考慮")
print("   - 初期SOCを調整 (5%ではなく高めに設定)")
print("   - または JEPX参加量を調整")
print("="*80)
