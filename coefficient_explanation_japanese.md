# 係数 0.040635 の由来と数式記号の説明
## Origin of Coefficient 0.040635 and Mathematical Notation

---

## 📊 1. 係数 0.040635 の由来

### 回帰分析から導出

**データソース:**
- 4日間の実測データ（9月22, 23, 25, 26日）
- 12個のデータポイント

**回帰式（1時間あたり）:**
```
ΔSOC (%/時間) = 0.013545 × 基準値(kW) - 2.8197

説明:
• 0.013545 = 傾き (slope) - 回帰分析で計算
• -2.8197 = 切片 (intercept) - 回帰分析で計算
• R² = 0.996037 (非常に高い精度)
```

**3時間ブロックへの変換:**
```
1ブロック = 3時間

ΔSOC (3時間) = (0.013545 × 基準値 - 2.8197) × 3
             = 0.013545 × 3 × 基準値 - 2.8197 × 3
             = 0.040635 × 基準値 - 8.4591

∴ 0.040635 = 0.013545 × 3
```

### 計算検証:
```python
# 1時間の係数
slope_per_hour = 0.013545
intercept_per_hour = -2.8197

# 3時間ブロックへ変換
slope_per_3h = slope_per_hour × 3
intercept_per_3h = intercept_per_hour × 3

print(f"傾き (3時間): {slope_per_3h}")      # 0.040635
print(f"切片 (3時間): {intercept_per_3h}")   # -8.4591
```

**結果:**
```
0.040635 = 0.013545 × 3
8.4591 = 2.8197 × 3
```

---

## 📐 2. 回帰分析の詳細

### 元データ（例）:

| 日付 | 時刻 | 基準値 (kW) | ΔSOC (%/h) |
|------|------|-------------|------------|
| 9/22 | 12:00 | 500 | 4.0 |
| 9/22 | 15:00 | 800 | 8.0 |
| 9/23 | 09:00 | 300 | 1.2 |
| ... | ... | ... | ... |

### 線形回帰:
```
y = a × x + b

ここで:
  y = ΔSOC (%/時間)
  x = 基準値 (kW)
  a = 傾き (slope) = 0.013545
  b = 切片 (intercept) = -2.8197
```

### Pythonコード（実際に使用）:
```python
import pandas as pd
from scipy.stats import linregress

# データ読み込み
df = pd.read_csv('kotohira_data.csv')

# 回帰分析
slope, intercept, r_value, p_value, std_err = linregress(
    df['基準値'], 
    df['ΔSOC_per_hour']
)

print(f"傾き: {slope}")        # 0.013545
print(f"切片: {intercept}")     # -2.8197
print(f"R²: {r_value**2}")     # 0.996037
```

---

## 🔤 3. 数式記号の説明

### f(b) = Σbᵢ の意味

#### Σ (シグマ) - 総和記号

**定義:**
```
Σbᵢ = b₁ + b₂ + b₃ + ... + b₇
i=1
```

**読み方:**
- 日本語: 「シグマ」または「総和」
- 英語: "Sigma" または "Summation"

**意味:**
すべてのiについて、bᵢを足し合わせる

#### 添え字 (Subscript)

**bᵢ の意味:**
```
i = インデックス（番号）
bᵢ = i番目のブロックの基準値

例:
  b₁ = Block 1の基準値
  b₂ = Block 2の基準値
  ...
  b₇ = Block 7の基準値
```

#### 完全な表記:
```
  7
f(b) = Σ bᵢ
     i=1

読み方: 「iが1から7まで、bᵢの総和」
意味: b₁ + b₂ + b₃ + b₄ + b₅ + b₆ + b₇
```

### 具体例:

**例1: 均等パターン**
```
b₁ = b₂ = ... = b₇ = 507 kW

Σbᵢ = 507 + 507 + 507 + 507 + 507 + 507 + 507
    = 7 × 507
    = 3,549 kW
```

**例2: 不均等パターン**
```
b₁ = 400 kW
b₂ = 500 kW
b₃ = 600 kW
b₄ = 550 kW
b₅ = 450 kW
b₆ = 520 kW
b₇ = 529 kW

Σbᵢ = 400 + 500 + 600 + 550 + 450 + 520 + 529
    = 3,549 kW
```

---

## 📊 4. 制約式の詳細説明

### 0.040635 × Σbᵢ = const とは？

#### ステップバイステップ:

**Step 1: 各ブロックのΔSOC**
```
ΔSOC₁ = 0.040635 × b₁ - 8.4591
ΔSOC₂ = 0.040635 × b₂ - 8.4591
...
ΔSOC₇ = 0.040635 × b₇ - 8.4591
```

**Step 2: 総ΔSOC**
```
総ΔSOC = ΔSOC₁ + ΔSOC₂ + ... + ΔSOC₇
       = Σ(0.040635 × bᵢ - 8.4591)
       = 0.040635 × Σbᵢ - 7 × 8.4591
       = 0.040635 × Σbᵢ - 59.2137
```

**Step 3: サイクル制約**
```
SOC初期 = 5%
SOC最終 = 90% (JEPX前)

総ΔSOC = 90 - 5 = 85%

∴ 0.040635 × Σbᵢ - 59.2137 = 85
  0.040635 × Σbᵢ = 144.2137 ← これが制約式
```

#### なぜ「線形」か？

**定義:**
線形制約 = 変数の1次式

```
0.040635 × Σbᵢ = const
= 0.040635 × (b₁ + b₂ + ... + b₇) = const
= 0.040635×b₁ + 0.040635×b₂ + ... + 0.040635×b₇ = const
```

**重要な点:**
- 各変数bᵢは1次（bᵢ¹）のみ
- bᵢ² や bᵢ³ などの高次項なし
- bᵢ×bⱼ などの積の項なし
- **すべてのbᵢの係数が同じ (0.040635)**

---

## 🎯 5. なぜこの係数が重要か？

### 対称性の理由

**目的関数:**
```
f(b) = Σbᵢ = 1×b₁ + 1×b₂ + ... + 1×b₇
```
→ すべての係数が **1**

**制約式:**
```
g(b) = 0.040635×b₁ + 0.040635×b₂ + ... + 0.040635×b₇
```
→ すべての係数が **0.040635**

**結論:**
```
係数が均一
⟹ どのbᵢも「対等」
⟹ 特定のブロックを優先する理由なし
⟹ 最適解は均等分布: b₁ = b₂ = ... = b₇
```

### 視覚的理解:

```
もし係数が異なれば:
  0.1×b₁ + 0.2×b₂ + 0.3×b₃ + ...
  ⟹ b₃の影響が大きい → b₃を優先的に増やす

実際の場合:
  0.040635×b₁ + 0.040635×b₂ + 0.040635×b₃ + ...
  ⟹ すべて同じ影響 → どれも均等に扱う
```

---

## 📐 6. 数値検証

### 実際の計算例:

**前提:**
```
b₁ = b₂ = ... = b₇ = 507 kW
```

**Step 1: 各ブロックのΔSOC**
```
ΔSOCᵢ = 0.040635 × 507 - 8.4591
      = 20.602 - 8.4591
      = 12.143%
```

**Step 2: 総ΔSOC**
```
総ΔSOC = 7 × 12.143%
       = 85.001%
       ≈ 85% ✅
```

**Step 3: SOC軌跡**
```
初期:   5.000%
Block 1: 5.000 + 12.143 = 17.143%
Block 2: 17.143 + 12.143 = 29.286%
Block 3: 29.286 + 12.143 = 41.429%
Block 4: 41.429 + 12.143 = 53.572%
Block 5: 53.572 + 12.143 = 65.715%
Block 6: 65.715 + 12.143 = 77.858%
Block 7: 77.858 + 12.143 = 90.001% ≈ 90% ✅
```

---

## 📊 7. まとめ図表

### 回帰分析の流れ:

```
実測データ (4日間)
    ↓
線形回帰分析
    ↓
ΔSOC = 0.013545 × 基準値 - 2.8197  (1時間)
    ↓
× 3時間
    ↓
ΔSOC = 0.040635 × 基準値 - 8.4591  (3時間ブロック)
    ↓
      ↓
0.040635 ← この係数が制約式に使用される
```

### 記号の対応表:

| 記号 | 意味 | 値/単位 |
|------|------|---------|
| bᵢ | i番目のブロックの基準値 | kW |
| Σbᵢ | 全ブロックの基準値合計 | kW |
| 0.040635 | 回帰係数（3時間） | %/kW |
| 8.4591 | 回帰切片（3時間） | % |
| ΔSOCᵢ | i番目のブロックのSOC変化 | % |
| f(b) | 目的関数（最大化） | kW |
| R² | 決定係数（精度） | 0.996037 |

---

## ✅ 結論

### 1. 0.040635 の由来:
```
実測データから回帰分析
→ 1時間係数: 0.013545
→ 3時間ブロック: 0.013545 × 3 = 0.040635
```

### 2. Σbᵢ の意味:
```
Σbᵢ = b₁ + b₂ + ... + b₇ (全ブロックの合計)
```

### 3. なぜ重要か:
```
係数が均一 (すべて0.040635)
⟹ 対称性
⟹ 均等分布が最適
```

---

*作成日: 2025年10月31日*  
*データソース: 琴平実測データ (9/22, 23, 25, 26)*
